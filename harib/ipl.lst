GAS LISTING ipl.s 			page 1


   1              	# initial program loader    
   2              	    .code16
   3              	
   4              	    .set CYLS, 10 # is this ok?
   5              	
   6 0000 EB4E     	    jmp entry # .byte 0xeb, 0x4e „ÅÆ„Åã„Çè„ÇäÔºü
   7 0002 90       	    .byte 0x90 # ?
   8 0003 53415249 	    .ascii "SARISIA " # boot sector name
   8      53494120 
   9 000b 0002     	    .word 512 # BPB_BytePerSec
  10 000d 01       	    .byte 1 # BPB_SecPerClus
  11 000e 0100     	    .word 1 # BPB_RsvdSecCnt ‰∫àÁ¥ÑÈ†òÂüü„Çª„ÇØ„ÇøÊï∞ „Éñ„Éº„Éà„Çª„ÇØ„ÇøÂê´„ÇÄ
  12 0010 02       	    .byte 2 # BPB_NumFATs
  13 0011 E000     	    .word 224 # root directory size
  14 0013 400B     	    .word 2880 # drive size
  15 0015 F0       	    .byte 0xf0 # BPB_Media
  16 0016 0900     	    .word 9 # BPB_FATSz16 (sector)
  17 0018 1200     	    .word 18 # sectors per track
  18 001a 0200     	    .word 2 # head nums
  19 001c 00000000 	    .int 0 # partition nums
  20 0020 400B0000 	    .int 2880 # drive size
  21 0024 000029   	    .byte 0, 0, 0x29 # BS_DrvNum, BS_Reserved1, BS_BootSig
  22 0027 FFFFFFFF 	    .int 0xffffffff # BS_VolID
  23 002b 48454C4C 	    .ascii "HELLOOS    " # disk name
  23      4F4F5320 
  23      202020
  24 0036 46415431 	    .ascii "FAT12   " # format name
  24      32202020 
  25 003e 00000000 	    .skip 18 # BS_BootCode begin
  25      00000000 
  25      00000000 
  25      00000000 
  25      0000
  26              	
  27              	entry:
  28              	    # init registers
  29 0050 B80000   	    mov $0, %ax # ax: 16bit accumulator register
  30 0053 8ED0     	    mov %ax, %ss # ss: 16bit stack segment register
  31 0055 BC007C   	    mov $0x7c00, %sp # sp: 16bit stack pointer
  32 0058 8ED8     	    mov %ax, %ds # ds: 16bit data segment
  33              	
  34              	# call BIOS to read disk
  35 005a B82008   	    mov $0x0820, %ax
  36 005d 8EC0     	    mov %ax, %es # es: 16bit extra segment
  37 005f B500     	    mov $0, %ch # ch: 8bit counter high # „Ç∑„É™„É≥„ÉÄ0 (ÊúÄ„ÇÇÂ§ñÂë®)
  38 0061 B600     	    mov $0, %dh # dh: 8bit data high # „Éò„ÉÉ„Éâ0 (Ë°®)
  39 0063 B102     	    mov $2, %cl # cl: 8bit counter low # „Çª„ÇØ„Çø2 („Çª„ÇØ„Çø1„ÅØIPL„ÄÅ„Å§„Åæ„Çä„Åì„Çå „Çª„ÇØ„Çø„Ç
  40              	
  41              	readloop:
  42 0065 BE0000   	    mov $0, %si # fail counter
  43              	retry:
  44 0068 B402     	    mov $0x02, %ah # disk read
  45 006a B001     	    mov $1, %al # num of sectors to process
  46 006c BB0000   	    mov $0, %bx # buffer address?
  47 006f B200     	    mov $0x00, %dl # dl: 8bit data low
  48 0071 CD13     	    int $0x13 # BIOS: disk
  49              	
GAS LISTING ipl.s 			page 2


  50              	    # success
  51 0073 7310     	    jnc next # bios returns CF=0 if success else CF=1
  52              	
  53              	    # fail
  54 0075 83C601   	    add $1, %si
  55 0078 83FE05   	    cmp $5, %si # flag: o..szapc
  56 007b 732E     	    jae error # jump above or equal
  57              	
  58              	    # call BIOS to reset
  59 007d B400     	    mov $0x00, %ah # reset
  60 007f B200     	    mov $0x00, %dl # drive index (fda)
  61 0081 CD13     	    int $0x13 # BIOS: disk
  62 0083 EBE3     	    jmp retry
  63              	
  64              	next:
  65 0085 8CC0     	    mov %es, %ax # x86 do not have  `ADD ES addr`
  66 0087 83C020   	    add $0x20, %ax # 512 byte (1 sector) / 16 (memory index segment)
  67 008a 8EC0     	    mov %ax, %es
  68 008c 80C101   	    add $1, %cl # „Çª„ÇØ„Çø„Çí„Ç§„É≥„ÇØ„É™„É°„É≥„Éà
  69 008f 80F912   	    cmp $18, %cl 
  70              	
  71              	    # if %cl (sector) <= 18
  72 0092 76D1     	    jbe readloop # jump below or equal
  73              	
  74              	    # else
  75 0094 B101     	    mov $1, %cl # reset sector
  76 0096 80C601   	    add $1, %dh # add head 1
  77 0099 80FE02   	    cmp $2, %dh
  78              	
  79              	    # if dh (head) < 2
  80 009c 72C7     	    jb readloop
  81              	
  82              	    # else
  83 009e B600     	    mov $0, %dh # reset head to 0
  84 00a0 80C501   	    add $1, %ch # increment cylinder
  85 00a3 80FD0A   	    cmp $CYLS, %ch
  86              	
  87              	    # if %ch (cylinder) < CYLS
  88 00a6 72BD     	    jb readloop # jump below
  89              	
  90              	fin:
  91 00a8 F4       	    hlt # ring level 0???
  92 00a9 EBFD     	    jmp fin
  93              	
  94              	error:
  95 00ab BE0000   	    mov $msg, %si
  96              	putloop:
  97 00ae 8A04     	    mov (%si), %al # al: 8bit accumulator low
  98 00b0 83C601   	    add $1, %si
  99 00b3 3C00     	    cmp $0, %al # cmp overwrites flag register  # if %al is 0, stop output chars
 100 00b5 74F1     	    je fin
 101 00b7 B40E     	    mov $0x0e, %ah # 8bit ah: accumlator high # bios output char function
 102 00b9 BB0F00   	    mov $15, %bx # bx: 16bit base register
 103 00bc CD10     	    int $0x10 # bios interrupt call
 104 00be EBEE     	    jmp putloop
 105              	
 106              	msg:
GAS LISTING ipl.s 			page 3


 107 00c0 0A0A     	    .ascii "\n\n"
 108 00c2 6C6F6164 	    .ascii "load error!"
 108      20657272 
 108      6F7221
 109 00cd 0A00     	    .asciz "\n" # https://sourceware.org/binutils/docs/as/Asciz.html#Asciz
 110              	
 111              	# finalize boot sector
 112 00cf 00000000 	    .org 0x01fe # 0x7dfe „Åß„ÅØ„Å™„ÅÑ
 112      00000000 
 112      00000000 
 112      00000000 
 112      00000000 
 113 01fe 55AA     	    .byte 0x55, 0xaa # BS_BootSign
GAS LISTING ipl.s 			page 4


DEFINED SYMBOLS
               ipl.s:4      *ABS*:000000000000000a CYLS
               ipl.s:27     .text:0000000000000050 entry
               ipl.s:41     .text:0000000000000065 readloop
               ipl.s:43     .text:0000000000000068 retry
               ipl.s:64     .text:0000000000000085 next
               ipl.s:94     .text:00000000000000ab error
               ipl.s:90     .text:00000000000000a8 fin
               ipl.s:106    .text:00000000000000c0 msg
               ipl.s:96     .text:00000000000000ae putloop

NO UNDEFINED SYMBOLS
